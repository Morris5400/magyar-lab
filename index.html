<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#111827" />
  <title>MagyarLab – Ungarisch A1–C2</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <style>
    :root{
      --bg: #f8fafc;
      --panel: #ffffff;
      --text: #0f172a;
      --muted: #475569;
      --brand: #2563eb;
      --brand-2: #1d4ed8;
      --ok: #059669;
      --warn: #eab308;
      --danger: #e11d48;
      --border: #e2e8f0;
      --chip: #f1f5f9;
      --shadow: 0 10px 20px rgba(2,6,23,0.06), 0 2px 6px rgba(2,6,23,0.08);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Inter, "Noto Sans", "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background: linear-gradient(180deg, #f8fafc 0%, #fff 100%);
    }

    #app{ max-width: 1100px; margin: 0 auto; padding: 20px; }

    .nav{ display:flex; align-items:center; justify-content:space-between; }
    .title{ display:flex; align-items:center; gap:10px; cursor: pointer; }
    .title .logo{ width:28px; height:28px; background:var(--brand); border-radius:8px; display:grid; place-items:center; color:#fff; font-weight:700; }

    .topbar.hidden{ display:none; }

    .grid{ display:grid; gap:16px; }
    .grid-1{ grid-template-columns: 1fr; }
    .grid-2{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .grid-3{ grid-template-columns: repeat(3, minmax(0, 1fr)); }
    @media (max-width:1024px){
      .grid-3{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width:640px){
      .grid-2, .grid-3{ grid-template-columns:1fr; }
    }

    .card{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: var(--shadow);
    }
    .card .hd{ padding:14px 16px; border-bottom:1px solid var(--border); font-weight:700; }
    .card .bd{ padding:16px; }
    .card .ft{ padding:14px 16px; border-top:1px solid var(--border); display:flex; gap:10px; justify-content:space-between; align-items:center; }

    .progress{ height:10px; background:#e5e7eb; border-radius:999px; overflow:hidden; }
    .progress > i{ display:block; height:100%; background:linear-gradient(90deg, var(--brand), var(--brand-2)); width:0%; }

    .badge{ display:inline-flex; align-items:center; gap:6px; padding:4px 8px; font-size:12px; color:#0b1220; background:var(--chip); border-radius:999px; border:1px solid var(--border); }
    .badge.ok{ color:#064e3b; background:#ecfdf5; border-color:#d1fae5; }
    .badge.warn{ color:#7c2d12; background:#fffbeb; border-color:#fef3c7; }

    .btn{
      appearance:none; border:none; cursor:pointer;
      padding:10px 12px; border-radius:10px; font-weight:600;
      background:#fff; border:1px solid var(--border); color:var(--text);
    }
    .btn:focus{ outline:2px solid var(--brand); outline-offset:2px; }
    .btn:hover{ background:#f8fafc; }
    .btn.primary{ background:var(--brand); color:#fff; border-color:transparent; }
    .btn.primary:hover{ background:var(--brand-2); }
    .btn.ghost{ background:transparent; border-color:transparent; color:var(--muted); }
    .btn.danger{ background:var(--danger); color:#fff; border-color:transparent; }
    .btn.ok{ background:var(--ok); color:#fff; border-color:transparent; }
    .btn.block{ width:100%; }
    .btn.icon{ padding:8px 10px; }

    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }

    .hr{ height:1px; background:var(--border); margin:10px 0; }

    .input, .select{
      padding:10px 12px; border:1px solid var(--border); border-radius:10px; width:100%;
      background:#fff;
    }
    label{ font-size:14px; color:var(--muted); }

    .chips{ display:flex; gap:6px; flex-wrap:wrap; }
    .chips .chip{ padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:var(--chip); font-size:12px; }

    .example{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      border:1px solid var(--border); border-radius:10px; padding:10px 12px;
    }
    .example .hu{ font-weight:600; }
    .example .de{ font-size:14px; color:var(--muted); }

    .exercise .item{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; align-items:center; }
    @media (max-width: 800px){ .exercise .item{ grid-template-columns: 1fr; } }

    .notice{ color:var(--muted); font-size:14px; }
    .small{ font-size:12px; color:var(--muted); }

    /* Startseite */
    .hero {
      background: linear-gradient(135deg, #eef2ff, #ffffff);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 22px;
      box-shadow: var(--shadow);
    }

    .level-grid { display:flex; gap:10px; flex-wrap:wrap; }
    .level-btn{
      padding:10px 14px; border:1px solid var(--border); border-radius:12px;
      background:#fff; cursor:pointer; font-weight:700;
      transition: transform 160ms ease, box-shadow 160ms ease, background 160ms ease;
    }
    .level-btn.active{ background:var(--brand); color:#fff; border-color:transparent; }
    .level-btn:hover{ transform: translateY(-1px); box-shadow: var(--shadow); }

    .link-cards{ display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:16px; }
    @media (max-width: 900px){ .link-cards{ grid-template-columns: 1fr; } }

    .card.link-card{ cursor:pointer; transition: transform 160ms ease, box-shadow 160ms ease; }
    .card.link-card:hover{ transform: translateY(-2px) scale(1.01); box-shadow: var(--shadow); }
    .card.link-card .hd{ display:flex; align-items:center; gap:10px; }
    .card.link-card .icon{ width:28px; height:28px; border-radius:8px; display:grid; place-items:center; color:#fff; background:var(--brand); }

    .home-progress{ display:flex; align-items:center; gap:12px; }
    .footer{
      margin-top: 24px; padding: 16px;
      color: var(--muted); font-size: 13px; text-align:center;
      border-top: 1px solid var(--border);
    }

    /* Modal / Overlay */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(15,23,42,0.45); display:grid; place-items:center; z-index:50; }
    .modal-card{ background:#fff; border:1px solid var(--border); border-radius:14px; box-shadow: var(--shadow); width:min(560px, 92vw); }
    .modal-card .hd{ padding:14px 16px; border-bottom:1px solid var(--border); font-weight:700; }
    .modal-card .bd{ padding:16px; }
    .modal-card .ft{ padding:14px 16px; border-top:1px solid var(--border); display:flex; gap:10px; justify-content:flex-end; }

    /* Chat-FAB */
    .fab{ position:fixed; right:16px; bottom:16px; z-index:40; }
    .fab .btn{ border-radius:999px; padding:12px 14px; box-shadow: var(--shadow); }
    .chat-panel{ position:fixed; right:16px; bottom:76px; width:360px; max-width:calc(100vw - 32px); height:560px; background:#fff; border:1px solid var(--border); border-radius:16px; box-shadow: var(--shadow); z-index:45; display:none; }
    .chat-panel.open{ display:block; }
    .chat-panel .hd{ padding:10px 12px; border-bottom:1px solid var(--border); font-weight:700; }
    .chat-panel .bd{ padding:10px 12px; height: calc(100% - 100px); overflow:auto; }
    .chat-panel .ft{ padding:10px 12px; border-top:1px solid var(--border); display:flex; gap:8px; }

    /* Slide-in Drawer Menü */
    .drawer-backdrop{
      position: fixed; inset: 0;
      background: rgba(15,23,42,0.45);
      z-index: 100;
      display: block;
    }

    .drawer{
      position: fixed; top: 0; right: 0; height: 100%;
      width: clamp(300px, 33vw, 420px);
      background: #fff;
      border-left: 1px solid var(--border);
      box-shadow: var(--shadow);
      transform: translateX(100%);
      transition: transform 240ms ease;
      display: grid;
      grid-template-rows: auto 1fr auto;
    }
    .drawer.open{ transform: translateX(0); }

    .drawer-hd{
      padding: 12px 14px; border-bottom: 1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .drawer-bd{
      padding: 12px; display:flex; flex-direction:column; gap:8px; overflow:auto;
    }
    .drawer-bd .item{ text-align:left; }
    .drawer-ft{
      padding: 10px 12px; border-top: 1px solid var(--border); text-align:center;
    }

    .body{
      max-width: 1000px;
      margin: 12px auto 24px auto;
      padding: 0 12px;
    }
  </style>
</head>
<body>
  <noscript>Bitte JavaScript aktivieren – diese App benötigt JS.</noscript>
  <div id="app"></div>

  <script>
// MagyarLab – Static SPA (vanilla JS, no build tools)
(function () {
  const LS_KEY = "magyarlab-v1-state";
  const APP_VERSION = 2;

  // Storage
  function loadState() {
    try {
      const raw = localStorage.getItem(LS_KEY);
      return raw ? JSON.parse(raw) : null;
    } catch (e) { return null; }
  }
  function saveState() {
    if (!state?.profile?.allowOffline) return;
    try { localStorage.setItem(LS_KEY, JSON.stringify(state)); } catch (e) {}
  }

  // Default State
  const DEFAULT_STATE = {
    meta: { version: APP_VERSION },
    profile: {
      audience: "de",
      level: null,
      examPrep: true,
      audio: { slow: true, normal: true },
      allowOffline: true,
      feedback: true,
      audioMode: "normal"
    },
    progress: {
      completedLessons: {},
      scores: {},
    },
    srs: {},
    ui: { tab: "lessons", route: "home", lessonId: null, hideTopbar: false, menuOpen: false, chatOpen: false },
    todayPlan: [],
  };

  // Init + Migration
  let state = loadState() || structuredClone(DEFAULT_STATE);

  (function migrate() {
    if (!state.meta) state.meta = { version: 1 };
    const prev = state.meta.version || 1;

    if (state.profile) {
      delete state.profile.track;
      delete state.profile.modes;
    }

    if (prev < APP_VERSION) {
      if (!state.profile.level) state.profile.level = "B2";
      state.ui.route = "onboarding";
      state.ui.tab = "lessons";
      state.meta.version = APP_VERSION;
    }

    if (!state.profile.level) state.profile.level = "B2";
    if (!state.profile.audioMode) state.profile.audioMode = "normal";
  })();

  // Curriculum
  const CURRICULUM = {
    B2: [
      {
        id: "b2-u1",
        title: "Vokalharmonie (2): richtige Endung wählen",
        grammar: [
          { name: "Front-/Back-/Gemischte Wörter (recap & edge cases)" },
          { name: "Bindevokale bei Suffixen (-o/-e, -a/-e, -ban/-ben, -hoz/-hez/-höz…)" },
          { name: "Zusammengesetzte Wörter: letzte Wurzel entscheidet" },
        ],
        examples: [
          { hu: "A könyvben jegyzetel.", de: "Er/sie schreibt im Buch Notizen." },
          { hu: "A teraszról telefonálok.", de: "Ich telefoniere von der Terrasse." },
          { hu: "A tanárhoz megyünk.", de: "Wir gehen zum Lehrer." },
        ],
        exercises: [
          {
            type: "gap",
            prompt: "Setze die passende Richtungsendung ein:",
            items: [
              { q: "Bemegyek a szobá__.", a: "szobába" },
              { q: "Kijövök a ház__.", a: "házból" },
              { q: "Felmegyek az emelet__.", a: "emeletre" },
            ]
          }
        ],
        vocab: [
          { id: "terasz", hu: "terasz", de: "Terrasse" },
          { id: "jegyzetel", hu: "jegyzetel", de: "Notizen machen" },
          { id: "emelet", hu: "emelet", de: "Stockwerk" },
        ],
      },
      {
        id: "b2-u2",
        title: "Indefinit oder Definit? – Objekt & Artikel",
        grammar: [
          { name: "Kein direktes Objekt → indefinit" },
          { name: "Unbestimmter Artikel / Quantor → meist indefinit" },
          { name: "Bestimmter Artikel / Pronomen → definitiv" },
        ],
        examples: [
          { hu: "Olvasok egy könyvet.", de: "Ich lese ein Buch. (indef.)" },
          { hu: "Olvasom a könyvet.", de: "Ich lese das Buch. (def.)" },
          { hu: "Kérem a számlát.", de: "Ich bitte um die Rechnung. (def.)" },
        ],
        exercises: [
          {
            type: "gap",
            prompt: "Setze die richtige Verbform (indef./def.):",
            items: [
              { q: "Én ____ (néz) a filmet.", a: "nézem" },
              { q: "Mi ____ (vesz) egy új asztalt.", a: "veszünk" },
              { q: "Ő ____ (keres) a kulcsot.", a: "keresi" },
            ]
          }
        ],
        vocab: [
          { id: "szamla", hu: "számla", de: "Rechnung" },
          { id: "kulcs", hu: "kulcs", de: "Schlüssel" },
        ],
      },
    ],
  };

  // SRS
  function nextInterval(card, grade) {
    const now = Date.now();
    let { reps = 0, interval = 0, ease = 2.5 } = card || {};
    if (grade < 3) {
      return { reps: 0, interval: 5 * 60 * 1000, ease: Math.max(1.3, ease - 0.2), due: now + 5 * 60 * 1000 };
    }
    const newEase = Math.max(1.3, ease + (grade === 5 ? 0.15 : grade === 4 ? 0.05 : 0));
    let newInterval;
    if (reps === 0) newInterval = 12 * 60 * 60 * 1000;
    else if (reps === 1) newInterval = 3 * 24 * 60 * 60 * 1000;
    else newInterval = Math.round(interval * newEase);
    return { reps: reps + 1, interval: newInterval, ease: newEase, due: now + newInterval };
  }

  // TTS
  let VOICES = [];
  function loadVoices() {
    if (!("speechSynthesis" in window)) return;
    VOICES = speechSynthesis.getVoices();
  }
  loadVoices();
  if ("speechSynthesis" in window) {
    window.speechSynthesis.onvoiceschanged = loadVoices;
  }
  
  function speak(text, opts = {}) {
    if (!("speechSynthesis" in window)) return;
    try {
      const u = new SpeechSynthesisUtterance(text);
      const hu = VOICES.find(v => /hu/i.test(v.lang));
      u.voice = hu || null;
      u.lang = hu?.lang || "hu-HU";
      u.rate = (opts.rate != null ? opts.rate : getAudioRate());
      u.pitch = opts.pitch || 1;
      speechSynthesis.cancel();
      speechSynthesis.speak(u);
    } catch (e) {
      // no-op
    }
  }
  
  function getAudioRate(){
    try{
      const mode = (state && state.profile && state.profile.audioMode) || "normal";
      return mode === "slow" ? 0.85 : 1.0;
    } catch(e) { return 1.0; }
  }

  // Utils
  function el(tag, attrs={}, children=[]) {
    const node = document.createElement(tag);
    for (const [k,v] of Object.entries(attrs)) {
      if (k === "class") node.className = v;
      else if (k.startsWith("on")) node.addEventListener(k.slice(2), v);
      else if (k === "html") node.innerHTML = v;
      else if (k === "style") node.setAttribute("style", v);
      else node.setAttribute(k, v);
    }
    for (const c of [].concat(children)) {
      if (c == null) continue;
      if (typeof c === "string") node.appendChild(document.createTextNode(c));
      else node.appendChild(c);
    }
    return node;
  }
  
  function clear(node) { 
    while(node.firstChild) node.removeChild(node.firstChild); 
  }
  
  function fmtDate(d=new Date()) { 
    return d.toLocaleDateString(); 
  }

  // Plan
  function rebuildPlan() {
    const due = Object.entries(state.srs)
      .filter(([,v]) => !v?.due || v.due <= Date.now())
      .map(([id]) => ({ type: "srs", id }));

    const lvl = state.profile.level || "B2";
    const levelLessons = (CURRICULUM[lvl] || []);
    const nextLesson = levelLessons.find(l => !state.progress.completedLessons[l.id]);

    const plan = [...due.slice(0, 10)];
    if (nextLesson) plan.push({ type: "lesson", id: nextLesson.id });
    state.todayPlan = plan;
    saveState();
  }
  rebuildPlan();

  // App Root
  const root = document.getElementById("app");

  function render() {
    clear(root);
    if (!state.ui.hideTopbar) root.appendChild(Navbar());

    let view;
    if (state.ui.route === "home") view = ViewHome();
    else if (state.ui.route === "profile") view = ViewProfile();
    else if (state.ui.route === "onboarding") view = ViewOnboarding();
    else view = ViewDashboard();

    root.appendChild(view);
    root.appendChild(ChatFab());

    (function manageDrawer(){
      const existing = document.querySelector(".drawer-backdrop");
      if (state.ui.menuOpen) {
        if (!existing) {
          const d = DrawerMenu();
          document.body.appendChild(d);
          setTimeout(()=>{ d.focus(); }, 0);
        }
      } else {
        if (existing) existing.remove();
      }
    })();
  }

  // Navbar
  function Navbar(){
    const wrap = el("div", { class:"nav topbar" + (state.ui.hideTopbar ? " hidden" : "") }, [
      el("div", { class: "title", onclick: ()=>{ state.ui.route="home"; state.ui.lessonId=null; saveState(); render(); } }, [
        el("div", { class: "logo" }, ["M"]),
        el("div", {}, [ el("span", { class:"mono" }, ["MagyarLab"]), " ", el("span",{class:"badge"},["A1–C2"]) ]),
      ]),
    ]);
    return card;
  }

  function openGateModal(){
    const m = el("div", { class:"modal-backdrop", onclick:(e)=>{ if (e.target===m) m.remove(); } }, [
      el("div", { class:"modal-card" }, [
        el("div", { class:"hd" }, ["Noch keine Inhalte"]),
        el("div", { class:"bd" }, ["Für dein gewähltes Niveau sind derzeit keine Lektionen verfügbar. Bitte wähle B2 oder schaue später wieder vorbei."] ),
        el("div", { class:"ft" }, [
          el("button", { class:"btn", onclick:()=>m.remove() }, ["Schließen"]),
          el("button", { class:"btn primary", onclick:()=>{ state.profile.level="B2"; saveState(); m.remove(); render(); } }, ["Zu B2 wechseln"])
        ])
      ])
    ]);
    document.body.appendChild(m);
  }

  // Cards
  function CardDayPlan(){
    const lvl = state.profile.level || "B2";
    const lessons = CURRICULUM[lvl] || [];

    const lessonIds = new Set(lessons.map(l => l.id));
    const completedCount = Object.keys(state.progress.completedLessons || {})
      .filter(id => lessonIds.has(id)).length;
    const total = lessons.length;
    const pct = total ? Math.round((completedCount/total)*100) : 0;

    const dueCount = Object.values(state.srs).filter(v => !v || !v.due || v.due <= Date.now()).length;
    const bar = el("div", { class:"progress" }, [ el("i", { style:`width:${pct}%` }) ]);

    return el("div", { class:"card" }, [
      el("div", { class:"hd" }, ["Dein Lernplan ", el("span",{class:"badge"},[fmtDate()]) ]),
      el("div", { class:"bd" }, [
        el("div", {}, [bar, el("div", { class:"small", style:"margin-top:8px" }, [pct+"%"]) ]),
        el("div", { class:"hr" }),
        PlanList(),
      ]),
      el("div", { class:"ft" }, [
        el("div", { class:"row" }, [
          BtnOutline("Wiederholungen fällig: "+dueCount, ()=>{ state.ui.tab="reviews"; saveState(); render(); }),
          BtnOutline("Lektionen öffnen", ()=>{ state.ui.tab="lessons"; saveState(); render(); }),
          BtnOutline("Vokabeltrainer", ()=>{ state.ui.tab="trainer"; saveState(); render(); }),
        ])
      ])
    ]);
  }

  function BtnOutline(label, onclick){ 
    return el("button", { class:"btn", onclick }, [label]); 
  }

  function CardTips(){
    const dueCount = Object.values(state.srs)
      .filter(v => !v || !v.due || v.due <= Date.now()).length;
    
    const msg = dueCount > 10 ? 
      "Viele Wiederholungen fällig: 2 Blöcke à 10 Karten mit 5-Minuten-Pausen." :
      "Konstanz schlägt Intensität: 15–20 Minuten täglich reichen.";
      
    return el("div", { class:"card" }, [
      el("div", { class:"hd" }, ["Lern-Tipp"]),
      el("div", { class:"bd" }, [ msg ]),
    ]);
  }

  function PlanList(){
    const items = state.todayPlan || [];
    if (!items.length) return el("div", { class:"notice" }, ["Heute ist nichts fällig – nimm dir eine Lektion vor oder wiederhole Vokabeln."]);
    
    return el("div", {}, items.map(it => el("div", { class:"example" }, [
      el("div", {}, [
        el("div", { class:"hu" }, [ it.type === "srs" ? "Vokabel wiederholen" : "Lektion" ]),
        el("div", { class:"de small" }, [ it.type === "srs" ? `Karte: ${it.id}` : lessonTitle(it.id) ]),
      ]),
      el("div", { class:"row" }, [
        it.type === "srs" ? el("button", { class:"btn", onclick:()=>{ const v=vocabById(it.id); if (v) speak(v.hu); } }, ["🔊 Anhören"]) : null,
        el("button", { class:"btn primary", onclick:()=>{
          if (it.type === "srs"){ state.ui.tab="reviews"; }
          else { state.ui.tab="lessons"; state.ui.lessonId = it.id; }
          saveState(); render();
        }}, ["Öffnen"]),
      ]),
    ])));
  }

  // Lessons
  function LessonList(){
    const lvl = state.profile.level;
    if (!lvl) return el("div", { class:"card", style:"margin-top:16px" }, [
      el("div",{class:"hd"},["Kein Niveau gewählt"]),
      el("div",{class:"bd"},["Bitte wähle auf der Startseite ein Niveau."]),
      el("div",{class:"ft"},[ el("button",{class:"btn", onclick:()=>{ state.ui.route="home"; saveState(); render(); }},["Zur Startseite"]) ])
    ]);

    if (lvl !== "B2") {
      return el("div", { class:"card", style:"margin-top:16px" }, [
        el("div", { class:"hd" }, [`Lektionen – ${lvl}`]),
        el("div", { class:"bd" }, ["Keine Lektionen verfügbar."]),
        el("div", { class:"ft" }, [
          el("button",{class:"btn", onclick:()=>openGateModal()},["Hinweis anzeigen"]),
          el("button",{class:"btn", onclick:()=>{ state.ui.route="home"; saveState(); render(); }},["Zur Startseite"]),
        ])
      ]);
    }

    const lessons = CURRICULUM["B2"] || [];
    const grid = el("div", { class:"card" }, [
      el("div", { class:"hd" }, ["Lektionen – B2"]),
      el("div", { class:"bd grid grid-2" }, lessons.map(l => el("div", { class:"card" }, [
        el("div", { class:"hd" }, [l.title]),
        el("div", { class:"bd" }, [ el("div", { class:"chips" }, l.grammar.map(g => el("span", { class:"chip" }, [g.name]))) ]),
        el("div", { class:"ft" }, [
          el("button", {
            class:"btn primary block",
            onclick:()=>{
              state.ui.lessonId = l.id;
              state.ui.hideTopbar = true;
              saveState();
              render();
              window.scrollTo(0,0);
            }
          }, ["Öffnen"])
        ])
      ])))
    ]);

    return state.ui.lessonId ? LessonViewNew() : grid;
  }

  function lessonById(id){
    for (const lvl of Object.keys(CURRICULUM)){
      const hit = (CURRICULUM[lvl]||[]).find(l => l.id === id);
      if (hit) return hit;
    }
    return null;
  }
  
  function lessonTitle(id){ 
    const l=lessonById(id); 
    return l ? l.title : id; 
  }
  
  function vocabById(vocabId){
    for (const lvl of Object.keys(CURRICULUM)){
      for (const l of CURRICULUM[lvl]){
        const v = (l.vocab||[]).find(x => x.id === vocabId);
        if (v) return v;
      }
    }
    return null;
  }

  function LessonViewNew(){
    state.ui.hideTopbar = true; 
    saveState();
    
    const l = lessonById(state.ui.lessonId);
    if (!l) return el("div");
    
    const exitMenuBtn = el("button", { 
      class:"btn", 
      style:"position:absolute; right:16px; top:16px; z-index:25", 
      onclick:()=>{
        const m = el("div", { class:"modal-backdrop", onclick:(e)=>{ if (e.target===m) m.remove(); } }, [
          el("div", { class:"modal-card" }, [
            el("div", { class:"hd" }, ["Lektion"]),
            el("div", { class:"bd" }, ["Möchtest du fortsetzen oder die Lektion verlassen?"] ),
            el("div", { class:"ft" }, [
              el("button", { class:"btn", onclick:()=>m.remove() }, ["Fortsetzen"]),
              el("button", { class:"btn", onclick:()=>{ 
                state.progress.completedLessons[l.id] = true; 
                saveState(); 
                m.remove(); 
              } }, ["Speichern"]),
              el("button", { class:"btn danger", onclick:()=>{ 
                m.remove(); 
                state.ui.lessonId=null; 
                state.ui.hideTopbar=false; 
                saveState(); 
                render(); 
              } }, ["Verlassen"])
            ])
          ])
        ]);
        document.body.appendChild(m);
      }
    }, ["Menü"]);
    
    const absWrap = el("div", { style:"position:relative" }, []);
    absWrap.appendChild(exitMenuBtn);
    
    const bd = el("div", { class:"bd grid grid-2" }, [
      // links: Erklärung + Beispiele
      el("div", {}, [
        el("h3", {}, ["Grammatik (deutsch erklärt)"]),
        el("ul", {}, l.grammar.map(g => el("li", {}, [g.name]))),
        el("div", { class:"hr" }),
        el("h3", {}, ["Beispiele"]),
        ...l.examples.map(ex => el("div", { class:"example" }, [
          el("div", {}, [ 
            el("div", { class:"hu" }, [ex.hu]), 
            el("div", { class:"de" }, [ex.de]) 
          ]),
          el("button", { class:"btn icon", onclick:()=>speak(ex.hu) }, ["🔊"]),
        ])),
      ]),
      // rechts: Übungen + Vokabeln
      el("div", {}, [
        el("h3", {}, ["Übungen"]),
        ...renderExercises(l.exercises||[]),
        el("div", { class:"hr" }),
        el("h3", {}, ["Vokabeln"]),
        ...((l.vocab||[]).map(v => el("div", { class:"example" }, [
          el("div", {}, [ 
            el("div", { class:"hu" }, [v.hu]), 
            el("div", { class:"de" }, [v.de]) 
          ]),
          el("div", { class:"row" }, [
            el("button", { class:"btn icon", onclick:()=>speak(v.hu) }, ["🔊"]),
          ])
        ]))),
        el("div", { class:"row", style:"margin-top:8px" }, [
          el("button", { class:"btn", onclick: addVocabToSRS }, ["Zur Wiederholungsliste hinzufügen"]),
        ]),
      ]),
    ]);

    const card = el("div", { class:"card", style:"margin-top:16px" }, [
      el("div", { class:"hd" }, [l.title]),
      bd,
      el("div", { class:"ft" }, [
        el("button", { class:"btn ok", onclick: markComplete }, ["Lektion als erledigt markieren"]),
      ]),
    ]);
    
    absWrap.appendChild(card);
    return absWrap;

    function markComplete(){
      state.progress.completedLessons[l.id] = true;
      saveState(); 
      rebuildPlan(); 
      render();
    }
    
    function addVocabToSRS(){
      (l.vocab||[]).forEach(v => {
        if (!state.srs[v.id]) {
          state.srs[v.id] = { reps:0, interval:0, ease:2.5, due: Date.now() };
        }
      });
      saveState(); 
      rebuildPlan(); 
      render();
    }
  }

  function renderExercises(list){
    return list.map(ex => {
      if (ex.type === "gap") return GapExercise(ex);
      if (ex.type === "mc") return MCExercise(ex);
      if (ex.type === "match") return MatchExercise(ex);
      return el("div");
    });
  }

  function GapExercise(ex){
    const wrap = el("div", { class:"card exercise" }, [
      el("div", { class:"hd" }, [ex.prompt]),
      el("div", { class:"bd grid" }, (ex.items||[]).map((it,i) => GapItem(it,i))),
    ]);
    return wrap;
  }

  function GapItem(item, idx){
    let show = false;
    const ans = el("input", { class:"input", placeholder:"Antwort" });
    const sol = el("div", { class:"small", style:"display:none" }, ["Lösung: ", item.a]);
    const help = item.help ? el("div", { class:"small" }, [item.help]) : null;
    const row = el("div", { class:"item" }, [
      el("div", {}, [ item.q, help ]),
      el("div", { class:"row" }, [
        ans,
        el("button", { class:"btn", onclick:()=>{ 
          show = !show; 
          sol.style.display = show ? "" : "none"; 
        } }, ["💡"]),
      ]),
      sol
    ]);
    return row;
  }

  function MCExercise(ex){
    const opts = ex.options || [];
    const body = el("div", { class:"bd" }, opts.map((opt,i) => {
      return el("button", { class:"btn", onclick:()=>{
        [...body.children].forEach((btn, idx) => {
          btn.className = "btn" + (idx === ex.answer ? " ok" : (idx===i ? " danger" : ""));
        });
      }}, [opt]);
    }));
    return el("div", { class:"card" }, [
      el("div", { class:"hd" }, [ex.prompt]),
      body
    ]);
  }

  function MatchExercise(ex){
    return el("div", { class:"card" }, [
      el("div", { class:"hd" }, [ex.prompt]),
      el("div", { class:"bd grid" }, (ex.pairs||[]).map(p => el("div", { class:"row" }, [
        el("div", {}, [`${p.left}-`]),
        el("div", { class:"badge" }, [p.right])
      ]))),
      el("div", { class:"ft small" }, ["Hinweis: In echt als Drag-&-Drop geplant; hier als Vorschau."]),
    ]);
  }

  // Trainer / Reviews
  function Trainer(){
    const queue = [];
    for (const lvl of Object.keys(CURRICULUM)){
      for (const l of CURRICULUM[lvl]){
        for (const v of (l.vocab||[])){
          const meta = state.srs[v.id];
          if (meta && (!meta.due || meta.due <= Date.now())) queue.push(v);
        }
      }
    }
    let idx = 0;
    const current = () => queue[idx];

    function grade(g){
      const cur = current(); 
      if (!cur) return;
      const prev = state.srs[cur.id] || { reps:0, interval:0, ease:2.5 };
      state.srs[cur.id] = nextInterval(prev, g);
      saveState();
      idx += 1;
      render();
    }

    const card = el("div", { class:"card", style:"margin-top:16px" }, [
      el("div", { class:"hd" }, ["Vokabeltrainer"]),
      el("div", { class:"bd" }, [
        !current() ? el("div", { class:"notice" }, ["Keine fälligen Karten. Füge Vokabeln aus Lektionen hinzu oder warte bis zum Fälligkeitsdatum."])
        : el("div", { class:"grid" }, [
            el("div", { class:"hu", style:"font-size:28px; text-align:center; font-weight:800" }, [ current().hu ]),
            el("div", { class:"de", style:"text-align:center" }, [ current().de ]),
            el("div", { class:"row", style:"justify-content:center" }, [
              el("button", { class:"btn", onclick:()=>speak(current().hu) }, ["🔊 Anhören"]),
            ]),
            el("div", { class:"grid grid-2" }, [
              el("button", { class:"btn danger", onclick:()=>grade(0) }, ["Nochmal"]),
              el("button", { class:"btn", onclick:()=>grade(3) }, ["Schwer"]),
              el("button", { class:"btn", onclick:()=>grade(4) }, ["Gut"]),
              el("button", { class:"btn ok", onclick:()=>grade(5) }, ["Leicht"]),
            ]),
          ])
      ])
    ]);
    return card;
  }

  function Reviews(){ 
    return Trainer(); 
  }

  // Settings
  function Settings(){
    const lvls = ["A1","A2","B1","B2","C1","C2"];
    const card = el("div", { class:"card", style:"margin-top:16px" }, [
      el("div", { class:"hd" }, ["Einstellungen"]),
      el("div", { class:"bd grid grid-2" }, [
        el("div", {}, [
          el("label", {}, ["Niveau"]),
          el("select", { 
            class:"select", 
            onchange:(e)=>{ 
              state.profile.level = e.target.value; 
              saveState(); 
              rebuildPlan(); 
            }
          }, lvls.map(l => el("option", { 
            value:l, 
            selected: state.profile.level===l ? "selected": null 
          }, [l])))
        ]),
        el("div", {}, [
          el("label", {}, ["Hörmodus (TTS-Geschwindigkeit)"]),
          el("div", { class:"row" }, [
            el("button", { 
              class:"btn" + (state.profile.audioMode === "slow" ? " ok" : ""), 
              onclick:()=>{ 
                state.profile.audioMode="slow"; 
                saveState(); 
                render(); 
              } 
            }, ["Langsam"]),
            el("button", { 
              class:"btn" + (state.profile.audioMode !== "slow" ? " ok" : ""), 
              onclick:()=>{ 
                state.profile.audioMode="normal"; 
                saveState(); 
                render(); 
              } 
            }, ["Normal"]),
          ])
        ]),
        el("div", {}, [
          el("label", {}, ["Offline-Speicherung (localStorage)"]),
          el("div", { class:"row" }, [
            el("input", { 
              type:"checkbox", 
              checked: state.profile.allowOffline ? "checked" : null, 
              onchange:(e)=>{ 
                state.profile.allowOffline = e.target.checked; 
                saveState(); 
              } 
            }),
            el("span", {}, ["aktiv"])
          ])
        ]),
      ]),
      el("div", { class:"ft" }, [
        el("button", { 
          class:"btn danger", 
          onclick:()=>{ 
            localStorage.removeItem(LS_KEY); 
            location.reload(); 
          } 
        }, ["Alles zurücksetzen"]),
        el("span", { class:"small" }, ["Speichern erfolgt automatisch."])
      ])
    ]);
    return card;
  }

  function ChatFab(){
    const open = state.ui.chatOpen;
    const panel = el("div",{ class:"chat-panel"+(open?" open":"" ) },[
      el("div",{class:"hd"},["KI-Hilfe (Demo)"]),
      el("div",{class:"bd"},[
        el("div",{class:"small"},[
          "Stelle Fragen zu deinem Niveau (", state.profile.level || "—", ") und Seite (", state.ui.route, "). ",
          "Profil-Daten werden später einbezogen."
        ])
      ]),
      el("div",{class:"ft"},[
        el("input",{class:"input",placeholder:"Frage eingeben (Demo)"}),
        el("button",{class:"btn"},["Senden"])
      ])
    ]);
    
    const btn = el("div",{class:"fab"},[
      el("button",{
        class:"btn",
        onclick:()=>{ 
          state.ui.chatOpen = !state.ui.chatOpen; 
          saveState(); 
          render(); 
        }
      },[ state.ui.chatOpen ? "✖︎" : "Chat" ])
    ]);
    
    const wrap = el("div");
    wrap.appendChild(panel); 
    wrap.appendChild(btn);
    return wrap;
  }

  function closeMenu(){
    state.ui.menuOpen = false; 
    saveState(); 
    render();
  }

  function DrawerMenu(){
    const backdrop = el("div", {
      class: "drawer-backdrop",
      onclick: (e)=>{ if (e.target === backdrop) closeMenu(); }
    });

    backdrop.tabIndex = -1;
    backdrop.addEventListener("keydown", (e)=>{ if (e.key === "Escape") closeMenu(); });

    const drawer = el("div", { class: "drawer open" }, [
      el("div", { class:"drawer-hd" }, [
        el("div", { class:"title" }, [
          el("div", { class:"logo" }, ["M"]),
          el("div", {}, [ 
            el("span", { class:"mono" }, ["MagyarLab"]), 
            " ", 
            el("span",{class:"badge"},["A1–C2"]) 
          ])
        ]),
        el("button", { class:"btn", onclick: closeMenu }, ["✖︎"])
      ]),

      el("div", { class:"drawer-bd" }, [
        el("button", { 
          class:"item btn block", 
          onclick:()=>{ 
            state.ui.route="home"; 
            closeMenu(); 
          } 
        }, ["Start"]),
        el("button", { 
          class:"item btn block", 
          onclick:()=>{ 
            state.ui.route="app"; 
            state.ui.tab="lessons"; 
            closeMenu(); 
          } 
        }, ["Lektionen"]),
        el("button", { 
          class:"item btn block", 
          onclick:()=>{ 
            state.ui.route="app"; 
            state.ui.tab="trainer"; 
            closeMenu(); 
          } 
        }, ["Vokabeltrainer"]),
        el("button", { 
          class:"item btn block", 
          onclick:()=>{ 
            state.ui.route="app"; 
            state.ui.tab="reviews"; 
            closeMenu(); 
          } 
        }, ["Wiederholen"]),
        el("button", { 
          class:"item btn block", 
          onclick:()=>{ 
            state.ui.route="app"; 
            state.ui.tab="settings"; 
            closeMenu(); 
          } 
        }, ["Einstellungen"]),
        el("button", { 
          class:"item btn block", 
          onclick:()=>{ 
            state.ui.route="profile"; 
            closeMenu(); 
          } 
        }, ["Profil"]),
      ]),

      el("div", { class:"drawer-ft small" }, [
        "© MagyarLab"
      ])
    ]);

    backdrop.appendChild(drawer);
    return backdrop;
  }

  // Initial render
  window.addEventListener("DOMContentLoaded", function(){ render(); });
  render();

})();
  </script>
</body>
</html>
      el("div", { class:"menu-wrap" }, [
        el("button", { class:"menu-btn btn", onclick:()=>{
          state.ui.menuOpen = true; saveState(); render();
        }}, ["Menü"])
      ])
    ]);
    return wrap;
  }

  function ViewDashboard(){
    if (state.ui.tab === "lessons" && state.ui.lessonId){
      return el("div", { class:"body grid grid-1", style:"margin-top:16px" }, [
        LessonViewNew()
      ]);
    }

    return el("div", { class:"body grid grid-1", style:"margin-top:16px" }, [
      CardDayPlan(),
      CardTips(),
      el("div", { class:"hr" }),
      ViewRouter()
    ]);
  }

  function ViewRouter(){
    if (state.ui.tab === "lessons") return LessonList();
    if (state.ui.tab === "trainer") return Trainer();
    if (state.ui.tab === "reviews") return Reviews();
    if (state.ui.tab === "settings") return Settings();
    return el("div");
  }

  function ViewHome(){
    const lvl = state.profile.level;
    const lessons = lvl ? (CURRICULUM[lvl] || []) : [];
    const lessonIds = new Set(lessons.map(l => l.id));
    const completedCount = Object.keys(state.progress.completedLessons || {}).filter(id => lessonIds.has(id)).length;
    const total = lessons.length;
    const pct = total ? Math.round((completedCount / total) * 100) : 0;

    const levelBtns = ["A1","A2","B1","B2","C1","C2"].map(L =>
      el("button", {
        class: "level-btn" + (lvl===L ? " active" : ""),
        onclick: ()=>{ state.profile.level = L; saveState(); render(); }
      }, [L])
    );

    return el("div", { class:"body grid grid-1", style:"margin-top:16px" }, [
      el("div", { class:"hero" }, [
        el("div", { class:"row", style:"justify-content:space-between; align-items:flex-start; flex-wrap:wrap" }, [
          el("div", {}, [
            el("div", { style:"font-size:24px; font-weight:800; margin-bottom:6px" }, ["Willkommen bei MagyarLab"]),
            el("div", { class:"small" }, ["Wähle zuerst dein Niveau – Inhalte sind derzeit nur für B2 verfügbar."]),
          ]),
          el("div", { class:"home-progress" }, [
            el("div", { class:"progress", style:"width:160px" }, [ el("i", { style:`width:${pct}%` }) ]),
            el("span", { class:"small" }, [ lvl ? `${pct}% in ${lvl}` : "Kein Niveau gewählt" ])
          ])
        ]),
        el("div", { class:"hr" }),
        el("div", {}, [
          el("label", {}, ["Niveau wählen"]),
          el("div", { class:"level-grid", style:"margin-top:8px" }, levelBtns),
          el("div", { class:"small" }, ["Freundlicher Hinweis: Inhalte für andere Niveaus folgen."])
        ])
      ]),

      el("div", { class:"link-cards" }, [
        el("div", { class:"card link-card", onclick:()=>{ 
          if (state.profile.level && state.profile.level!=="B2") return openGateModal();
          state.ui.route="app"; state.ui.tab="lessons"; saveState(); render();
        } }, [
          el("div", { class:"hd" }, [ el("div",{class:"icon"},["📚"]), "Lektionen" ]),
          el("div", { class:"bd small" }, ["Zum Lektions-Grid."])
        ]),
        el("div", { class:"card link-card", onclick:()=>{ alert("Vokabeln-Feature kommt bald!"); } }, [
          el("div", { class:"hd" }, [ el("div",{class:"icon"},["🧠"]), "Meine Vokabeln" ]),
          el("div", { class:"bd small" }, ["Übersicht, Tabelle, Abfrage."])
        ]),
        el("div", { class:"card link-card", onclick:()=>{ 
          alert("Prüfungsvorbereitung kommt bald!");
        } }, [
          el("div", { class:"hd" }, [ el("div",{class:"icon"},["🎯"]), "Prüfungsvorbereitung" ]),
          el("div", { class:"bd small" }, ["Infos & Struktur – Inhalte folgen."])
        ]),
      ]),

      el("div", { class:"footer" }, ["© MagyarLab – Startseite"])
    ]);
  }

  function ViewProfile(){
    return el("div", { class:"body grid grid-1", style:"margin-top:16px; max-width: 960px; margin-inline:auto" }, [
      el("div", { class:"card" }, [
        el("div", { class:"hd" }, ["Profil"]),
        el("div", { class:"bd" }, ["Profil-Feature wird bald implementiert."]),
        el("div", { class:"ft" }, [
          el("button", { class:"btn", onclick: ()=>{ state.ui.route="home"; saveState(); render(); } }, ["Zur Startseite"]),
        ])
      ])
    ]);
  }

  function ViewOnboarding(){
    const lvls = ["A1","A2","B1","B2","C1","C2"];
    let chosenLevel = state.profile.level || "B2";

    const card = el("div", { class:"card", style:"margin-top:16px" }, [
      el("div", { class:"hd" }, ["Willkommen! Wähle dein Niveau"]),
      el("div", { class:"bd grid grid-2" }, [
        el("div", {}, [
          el("label", {}, ["Startniveau"]),
          el("div", { class:"row", style:"margin-top:6px; flex-wrap:wrap" },
            lvls.map(l => el("button", {
              class:"btn " + (chosenLevel===l?"primary":""), 
              onclick: () => { 
                chosenLevel = l; 
                // Re-render buttons
                render();
              }
            }, [l]))
          ),
          el("div", { class:"small" }, ["Du kannst später jederzeit wechseln."]),
        ]),
        el("div", {}, [
          el("label", {}, ["Hinweis"]),
          el("div", { class:"small" }, [
            "B2 ist aktuell mit neuen Lektionen befüllt. Andere Niveaus folgen."
          ]),
        ]),
      ]),
      el("div", { class:"ft" }, [
        el("div", { class:"small" }, ["Deutschsprachige Erklärungen, Ungarisch mit TTS."]),
        el("div", { class:"row
